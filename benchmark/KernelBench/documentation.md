# Benchmark Compilation Script

## Overview

This script automates the compilation of PyTorch models from the `KernelBench` suite into IREE artifacts (`.vmfb`). It is designed to be configurable, allowing compilation for multiple kernel levels and various hardware targets (e.g., NVIDIA GPUs, ARM/x86 CPUs, RISC-V) in a single run.

It generates compiled artifacts, intermediate MLIR, and detailed reports summarizing success and failure rates.

## Usage

Run the script from the repository's root directory. The primary arguments are `--targets` and `--levels`.

### Example

This command compiles `level1` and `level2` kernels for both the NVIDIA A100 and a generic Cascade Lake CPU target.

```bash
python3 benchmark/KernelBench/iree_compilation.py \
    --targets A100 cascadelake \
    --levels level1 level2
```

### Command-Line Arguments

* `--input_base_dir`: (Optional) Path to the `KernelBench/KernelBench` directory.
    * *Default*: `third_party/KernelBench/KernelBench`
* `--output_base_dir`: (Optional) Path to store compiled results.
    * *Default*: `benchmark/KernelBench/results`
* `--report_dir`: (Optional) Path to store logs and reports.
    * *Default*: `benchmark/KernelBench/report`
* `--levels`: (Required) A space-separated list of levels to compile (e.g., `level1 level3`).
* `--targets`: (Required) A space-separated list of target names to compile for (e.g., `A100 arm_cortex_a72`).
    * *Note*: These targets must be defined in the `TARGET_DEFINITIONS` dictionary within the script.

## Output Structure

The script generates two main sets of outputs: compiled artifacts and reports.

### 1. Results Directory (`--output_base_dir`)

This directory contains the actual compiled files, organized by level, target, and kernel.

```
<output_base_dir>/
└── <level>/
    └── <target_name>/
        └── <kernel_name>/
            ├── artifact.vmfb        # The final compiled IREE module
            ├── kernel.mlir          # The input MLIR generated by Turbine (text format)
            └── compilation_phases/  # Directory of all intermediate MLIR passes
                ├── 00_... .mlir
                └── 01_... .mlir
```

### 2. Report Directory (`--report_dir`)

This directory contains the summary of the compilation run.

```
<report_dir>/
├── iree_compile.log           # Detailed, verbose log of the entire run
├── iree_compile_report.json   # Machine-readable JSON with detailed success/failure statistics
└── iree_compile_report.md     # Human-readable Markdown summary with success percentages
```

## How to Add New Targets

To add a new CPU or GPU target:

1.  Open `benchmark/KernelBench/iree_compilation.py`.
2.  Locate the `TARGET_DEFINITIONS` dictionary near the top of the file.
3.  Add a new entry for your target, specifying its name, backend flags, precision, etc.
4.  Rerun the script using your new target's name in the `--targets` argument.